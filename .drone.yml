kind: pipeline
type: docker
name: arm-test

platform:
  arch: arm

steps:
- name: test
  image: golang
  environment:
    GITHUB_KEY:
      from_secret: api_key
  privileged: true
  commands:
  - losetup -a
  - apt-get update
  - apt-get dist-upgrade -y
  - apt-get install kpartx parted wget curl jq aria2 unzip python3 python3-pip qemu-user-static dmsetup g++-arm-linux-gnueabihf -y
  - python3 -m pip install requests
  - losetup -D
  - dmsetup remove_all
  - bash -c 'export GITHUB_KEY="$GITHUB_KEY";mkdir images && PATH=./node_modules/.bin:$PATH ./builder --noninteractive --armhf' # --arm64 or --armhf, need to implement in builder
  when:
    event:
      exclude:
        - tag
---
kind: pipeline
type: docker
name: arm-build

platform:
  arch: arm
steps:
- name: build
  image: golang
  environment:
    GITHUB_KEY:
      from_secret: api_key
  privileged: true
  commands:
  - losetup -a
  - apt-get update
  - apt-get dist-upgrade -y
  - apt-get install kpartx parted wget curl jq aria2 unzip python3 python3-pip qemu-user-static dmsetup nodejs g++-arm-linux-gnueabihf -y
  - python3 -m pip install requests
  - losetup -D
  - dmsetup remove_all
  - bash -c 'export GITHUB_KEY="$GITHUB_KEY";mkdir images && PATH=./node_modules/.bin:$PATH ./builder --noninteractive --armhf'
  - ./.travis/compress.sh
  - ./.travis/upload.sh
  when:
    event:
      include:
        - tag

---
kind: pipeline
type: docker
name: arm64-test

platform:
  arch: arm64

steps:
- name: test
  image: golang
  environment:
    GITHUB_KEY:
      from_secret: api_key
  privileged: true
  commands:
  - losetup -a
  - apt-get update
  - apt-get dist-upgrade -y
  - apt-get install kpartx parted wget curl jq aria2 unzip python3 python3-pip qemu-user-static dmsetup nodejs g++-aarch64-linux-gnueabihf -y
  - python3 -m pip install requests
  - losetup -D
  - dmsetup remove_all
  - bash -c 'export GITHUB_KEY="$GITHUB_KEY";mkdir images && PATH=./node_modules/.bin:$PATH ./builder --noninteractive --arm64'
  when:
    event:
      exclude:
        - tag

---
kind: pipeline
type: docker
name: arm64-build

platform:
  arch: arm64
steps:
- name: build
  image: golang
  environment:
    GITHUB_KEY:
      from_secret: api_key
  privileged: true
  commands:
  - losetup -a
  - apt-get update
  - apt-get dist-upgrade -y
  - apt-get install kpartx parted wget curl jq aria2 unzip python3 python3-pip qemu-user-static dmsetup nodejs g++-aarch64-linux-gnueabihf -y
  - python3 -m pip install requests
  - losetup -D
  - dmsetup remove_all
  - bash -c 'export GITHUB_KEY="$GITHUB_KEY";mkdir images && PATH=./node_modules/.bin:$PATH ./builder --noninteractive --arm64'
  - ./.travis/compress.sh
  - ./.travis/upload.sh
  when:
    event:
      include:
        - tag

---
kind: secret
name: api_key
data: oQcHB87i8xm+rxKZHAw4eGZgLjhwjAQB25IvPc9L1uOHopL8Sf/zt+UTkQAZzAiS+ompEdEdt6Biecd4onUX7JpJNsY=