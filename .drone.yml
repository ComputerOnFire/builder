kind: pipeline
type: docker
name: arm-test

platform:
  arch: arm

steps:
- name: test
  image: golang
  environment:
    GITHUB_KEY:
      from_secret: api_key
  privileged: true
  commands:
  - losetup -a
  - apt-get update
  - apt-get dist-upgrade -y
  - apt-get install kpartx parted wget curl jq aria2 unzip python3 python3-pip qemu-user-static dmsetup g++-arm-linux-gnueabihf nodejs npm git rsync -y
  - python3 -m pip install requests
  - dmsetup remove_all
  - losetup -D
  - bash -c 'export GITHUB_KEY="$GITHUB_KEY";mkdir images && PATH=./node_modules/.bin:$PATH ./builder --noninteractive --armhf' # --arm64 or --armhf, need to implement in builder
  when:
    event:
      exclude:
        - tag
---
kind: pipeline
type: docker
name: arm-build

platform:
  arch: arm
steps:
- name: build
  image: golang
  environment:
    GITHUB_KEY:
      from_secret: api_key
  environment:
    ssh_deploy_key:
      from_secret: ssh_secret
  privileged: true
  commands:
  - git fetch --tags
  - losetup -a
  - apt-get update
  - apt-get dist-upgrade -y
  - apt-get install kpartx parted wget curl jq aria2 unzip python3 python3-pip qemu-user-static dmsetup g++-arm-linux-gnueabihf nodejs npm git rsync -y
  - python3 -m pip install requests
  - dmsetup remove_all
  - losetup -D
  - bash -c 'export GITHUB_KEY="$GITHUB_KEY";mkdir images && PATH=./node_modules/.bin:$PATH ./builder --noninteractive --armhf'
  - echo "$ssh_deploy_key" | base64 --decode --ignore-garbage > .drone/id_deploy
 # - git tag --points-at HEAD | tail -n1 2>/dev/null | sed -e 's/^release-//'
  - .drone/environment.sh
  - echo "$experiment"
  - echo "$image_path"
  - .drone/compress.sh
  - .drone/upload.sh
  when:
    event:
      include:
        - tag

---
kind: pipeline
type: docker
name: arm64-test

platform:
  arch: arm64

steps:
- name: test
  image: golang
  environment:
    GITHUB_KEY:
      from_secret: api_key
  privileged: true
  commands:
  - losetup -a
  - apt-get update
  - apt-get dist-upgrade -y
  - apt-get install kpartx parted wget curl jq aria2 unzip python3 python3-pip qemu-user-static dmsetup g++-aarch64-linux-gnu nodejs npm git rsync -y
  - python3 -m pip install requests
  - dmsetup remove_all
  - losetup -D
  - bash -c 'export GITHUB_KEY="$GITHUB_KEY";mkdir images && PATH=./node_modules/.bin:$PATH ./builder --noninteractive --arm64'
  when:
    event:
      exclude:
        - tag

---
kind: pipeline
type: docker
name: arm64-build

platform:
  arch: arm64
steps:
- name: build
  image: golang
  environment:
    GITHUB_KEY:
      from_secret: api_key
  environment:
    ssh_deploy_key:
      from_secret: ssh_secret
  privileged: true
  commands:
  - git fetch --tags
  - losetup -a
  - apt-get update
  - apt-get dist-upgrade -y
  - apt-get install kpartx parted wget curl jq aria2 unzip python3 python3-pip qemu-user-static dmsetup g++-aarch64-linux-gnu nodejs npm git rsync -y
  - python3 -m pip install requests
  - dmsetup remove_all
  - losetup -D
  - bash -c 'export GITHUB_KEY="$GITHUB_KEY";mkdir images && PATH=./node_modules/.bin:$PATH ./builder --noninteractive --arm64'
  - echo "$ssh_deploy_key" | base64 --decode --ignore-garbage > .drone/id_deploy
 # - git tag --points-at HEAD | tail -n1 2>/dev/null | sed -e 's/^release-//'
  - .drone/environment.sh
  - echo "$experiment"
  - echo "$image_path"
  - .drone/compress.sh
  - .drone/upload.sh
  when:
    event:
      include:
        - tag

---
kind: secret
name: api_key
data: oQcHB87i8xm+rxKZHAw4eGZgLjhwjAQB25IvPc9L1uOHopL8Sf/zt+UTkQAZzAiS+ompEdEdt6Biecd4onUX7JpJNsY=
---
kind: secret
name: ssh_secret
data: F6cpUXE/17Q6/hxiVl6EUZ79mq0Mwq4aVFJWXzBegJ0iIcWwvEQFukqHoK1TWTdocojlot5a/XnKlFZ0j3Ut16KsTZP+75r8F9AuCxdNmqt2Vcmi/8af2YW6muwPBYHF9HAszlVCB3YeiS+/zlIxeima+a+jTHv9sHwlltr7pbJo5wkB0mKj4kk9m5+tsyi2FMNGuoPX4/CwubvFXv7GJ4T5XBgBi9g+ft5jQ8YbyqdA1Qi6rP5UT7/YX61hdlAlkCeOgAJQWYnvHaCYxi+G3QhFceknKCmfzhXN8Hz+/CKQDEn/80dZr1XvG1Ia8wW8Z9HHXszfUwrRElUEDLX7r2qndJmPI3K1uDOUXLEPljLbpxhBx5YPwmsRQDArdQHqg1XFaZFjjDMGUfKzuEOI+wDhv5rizx8bdbme4p5JpEGU/6Rc0B4ueVYAzezbwnJa5rsoaeWlzOfNCWLgvfU6X/h9INSFj3lM87+iN4p5Xhh5ApX5ZKTbf/ldB1VPSAjHVOD/qpKNNgOcT5zIL3beT9fZVPzXR8B0qODJvZvG/z3geGLMI8SVEU1yNzKl5sdnUxF/wnPRztBK+84XawKItq9bs4adMizJEmYVY4zRUySu8CqVnYBIHO/93jX0fpZrkUwL06ASefG2kbaO24VujKVp7TqtSL2Znh8sIKuvB+K3UHHDv1RTuahL+hi5h3bMUrN3qJjwF4FePyQEKfP0cP0firCEEoZuYUOmNl7oOlS1zATDDXSbFlRPUg1ZAQ2NxBMROIx1EnxO6a+KQ2oAgp9EQjLMhzLyElTBfGH76eSUjHUQCWH3YSywsYASezvGCQI90R2ATfPK2WLrXwYMQeikJV36sbqbDyIx0E/2J3ZCBmxtkqBv9pAnOoHEYuy/x60cBZOvovt9u4lKlBHpZUWKKAKy+L9fevohqJqxn9o=